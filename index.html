<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLOCK BLAST Adventure Master</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* –ê–Ω–∏–º–∞—Ü–∏—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ */
        @keyframes background-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        body {
            font-family: 'Poppins', sans-serif; 
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 30px;
            transition: background-color 0.3s, color 0.3s;
            
            /* –Ø—Ä–∫–∏–π –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
            background: linear-gradient(-45deg, #4a42f5, #6c5ce7, #a29bfe, #4a42f5);
            background-size: 400% 400%;
            animation: background-animation 20s ease infinite;
            color: #ecf0f1;
        }

        .game-container {
            background-color: #ffffff;
            padding: 25px;
            border-radius: 15px; /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤ */
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); /* –ì–ª—É–±–æ–∫–∞—è —Ç–µ–Ω—å */
            text-align: center;
            max-width: 380px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        h1 {
            font-weight: 700;
            color: #ff6b6b; /* –ö—Ä–∞—Å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            transition: color 0.3s;
            margin-top: 0;
            margin-bottom: 15px;
        }

        /* –ö–æ–º–±–æ-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä */
        #combo-display {
            font-weight: 700;
            text-shadow: 0 0 8px rgba(255, 165, 0, 0.8);
            letter-spacing: 1px;
            transition: opacity 0.5s;
            color: #e67e22;
            font-size: 1.1em;
            opacity: 0;
            min-height: 1.2em;
        }
        
        .score-panel {
            font-size: 1.3em;
            margin-bottom: 20px;
            font-weight: 600;
            color: #333;
        }
        
        #mode-info {
            font-size: 0.9em;
            font-weight: 400;
            margin-top: 5px;
            min-height: 1.1em;
        }

        /* –ö–Ω–æ–ø–∫–∏ –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ */
        .header-buttons {
            display: flex;
            justify-content: space-between;
            gap: 5px; /* –ù–µ–±–æ–ª—å—à–æ–π –∑–∞–∑–æ—Ä –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ */
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        /* –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ */
        #game-board {
            width: 256px;
            height: 256px;
            display: grid;
            grid-template-columns: repeat(8, 1fr); /* 8 –∫–æ–ª–æ–Ω–æ–∫ */
            grid-template-rows: repeat(8, 1fr);   /* 8 —Ä—è–¥–æ–≤ */
            border: 6px solid #ff9f43; /* –Ø—Ä–∫–∞—è —Ä–∞–º–∫–∞ */
            border-radius: 8px; /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ */
            background-color: #dfe6e9;
            margin: 0 auto 25px auto;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s, background-color 0.3s;
        }

        .cell {
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            border: 1px solid #b2bec3; /* –°–≤–µ—Ç–ª—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã */
            transition: background-color 0.1s, opacity 0.1s, transform 0.1s;
        }
        
        /* –ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —è—á–µ–π–∫–∞ */
        .filled {
            border: none;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2); /* –ù–µ–±–æ–ª—å—à–∞—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ç–µ–Ω—å –¥–ª—è –æ–±—ä–µ–º–∞ */
            opacity: 1 !important;
        }
        
        /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ò–ò */
        .ai-highlight-0 { 
            box-shadow: 0 0 8px 3px #1dd1a1 !important;
            border: 2px solid #1dd1a1 !important;
        }
        .ai-highlight-1 { 
            box-shadow: 0 0 8px 3px #54a0ff !important;
            border: 2px solid #54a0ff !important;
        }
        .ai-highlight-2 { 
            box-shadow: 0 0 8px 3px #ff9f43 !important;
            border: 2px solid #ff9f43 !important;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ */
        .clearing {
            animation: rainbow-fade 0.4s ease-in-out forwards;
        }

        @keyframes rainbow-fade {
            0% { background-color: #ff0084; transform: scale(1); opacity: 1; }
            50% { background-color: #3300ff; }
            100% { background-color: #00ff00; transform: scale(0); opacity: 0; }
        }

        /* –ü–∞–Ω–µ–ª—å —Å–ª–µ–¥—É—é—â–∏—Ö –±–ª–æ–∫–æ–≤ */
        .next-blocks-panel {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background-color: #f8f8f8;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s, border-color 0.3s;
        }

        #next-blocks {
            display: flex;
            justify-content: space-around;
            align-items: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
            padding: 10px 0;
            min-height: 100px;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–∏–≥—É—Ä—ã */
        .shape-container {
            width: 75px;
            height: 75px;
            display: flex; /* –î–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∏–≥—É—Ä—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
            justify-content: center;
            align-items: center;
            cursor: grab; /* –ö—É—Ä—Å–æ—Ä –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è */
            background: none; /* –£–±–∏—Ä–∞–µ–º —Ñ–æ–Ω */
            box-shadow: none;
            border-radius: 8px;
            transition: box-shadow 0.2s, opacity 0.2s;
        }
        
        /* –í–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è */
        .shape-container.is-dragging {
             opacity: 0.01;
             box-shadow: none;
        }
        
        /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ü–µ–ª–∏ –ò–ò –¥–ª—è —Ñ–∏–≥—É—Ä */
        .shape-container.ai-target-0 { box-shadow: 0 0 0 3px #1dd1a1; }
        .shape-container.ai-target-1 { box-shadow: 0 0 0 3px #54a0ff; }
        .shape-container.ai-target-2 { box-shadow: 0 0 0 3px #ff9f43; }
        
        .shape-container[draggable="true"]:hover {
             box-shadow: 0 0 0 2px #6c5ce7;
        }
        
        .shape {
            display: grid;
        }

        .block {
            width: 22px;
            height: 22px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            box-sizing: border-box;
        }
        
        /* –°—Ç–∏–ª—å –∫–Ω–æ–ø–æ–∫ */
        .game-button {
            padding: 10px 10px;
            flex-grow: 1;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 8px; /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ */
            font-weight: 600;
            transition: all 0.2s;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-size: 200% auto;
        }
        
        .game-button:hover {
            background-position: right center;
        }
        
        .game-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* –°—Ç–∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
        #reset-button { 
            background-image: linear-gradient(to right, #6c5ce7 0%, #a29bfe 100%);
        }
        #settings-button { 
            background-image: linear-gradient(to right, #ff7675 0%, #e84393 100%);
        }
        #mode-button { 
            background-image: linear-gradient(to right, #00b894 0%, #00cec9 100%);
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ (Modal) */
        .modal {
            display: none;
            position: fixed; 
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% —Å–≤–µ—Ä—Ö—É –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ */
            padding: 30px;
            border: none;
            width: 80%; /* –ú–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –∏–ª–∏ –º–µ–Ω—å—à–µ */
            max-width: 320px;
            border-radius: 15px;
            text-align: left;
            transition: background-color 0.3s;
            color: #333;
        }

        .close-button {
            color: #aaa;
            float: right; /* –†–∞–∑–º–µ—â–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∞ */
            font-size: 28px; 
            font-weight: bold;
        }

        .close-button:hover, .close-button:focus {
            color: #000;
            text-decoration: none; 
            cursor: pointer;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞/—Å–ª–æ–∂–Ω–æ—Å—Ç–∏ */
        .mode-selection-button {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            font-size: 1.1em;
            text-align: left;
            border: 2px solid transparent;
            background-color: #ecf0f1;
            color: #333;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background-image: linear-gradient(to right, #ffeaa7 0%, #fdcb6e 100%); /* –¢–µ–ø–ª—ã–π —Ñ–æ–Ω */
            background-size: 200% auto;
            color: #333;
        }

        .mode-selection-button.active {
            border-color: #6c5ce7;
            background-image: linear-gradient(to right, #a29bfe 0%, #6c5ce7 100%);
            color: white;
            font-weight: 600;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤ */
        #leaderboard-list {
            list-style-type: none;
            padding: 0;
        }
        #leaderboard-list li {
            padding: 10px;
            margin-bottom: 5px;
            background-color: #f1f1f1;
            border-radius: 8px;
            font-weight: 400;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #leaderboard-list li strong {
            color: #ff6b6b;
            font-size: 1.1em;
            margin-right: 10px;
        }
        
        .view-profile-button {
            margin-left: 10px;
            background-size: 100% auto !important;
        }

        /* –°—Ç–∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è */
        #profile-modal .modal-content {
             max-width: 380px;
        }
        #profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #ccc;
            margin: 0 auto 15px auto;
            display: block;
            object-fit: cover;
            border: 3px solid #6c5ce7;
        }
        #profile-stats p {
            font-size: 1.1em;
            margin: 8px 0;
            font-weight: 500;
        }
        #profile-stats strong {
            color: #ff6b6b;
            font-weight: 700;
        }
        #edit-profile-button {
            background-image: linear-gradient(to right, #2196F3 0%, #03A9F4 100%);
            margin-top: 20px;
        }
        #edit-profile-form {
            text-align: center;
        }
        #edit-profile-form input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            color: #333;
        }
        
        /* --- –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê --- */
        .dark-mode .game-container {
            background-color: #34495e;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
        }
        
        .dark-mode .score-panel { color: #ecf0f1; }
        .dark-mode #mode-info { color: #ccc !important; }
        .dark-mode #game-board {
            border: 6px solid #a29bfe;
            background-color: #4a637d; /* –ë–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω –ø–æ–ª—è */
        }
        .dark-mode .cell { border: 1px solid #7f8c8d; }
        .dark-mode .block { border: 1px solid rgba(255, 255, 255, 0.5); }
        .dark-mode .next-blocks-panel {
            background-color: #3f556d;
            border: 1px solid #5d6d7e;
        }
        
        .dark-mode .modal-content {
            background-color: #3f556d;
            color: #ecf0f1;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
        }
        .dark-mode .close-button { color: #ccc; }
        .dark-mode .close-button:hover { color: #fff; }
        
        .dark-mode .mode-selection-button {
            background-image: linear-gradient(to right, #f7f7f7 0%, #f1f1f1 100%);
            color: #333;
        }
        .dark-mode .mode-selection-button.active {
             border-color: #a29bfe;
             background-image: linear-gradient(to right, #8e44ad 0%, #a29bfe 100%);
             color: white;
        }
        .dark-mode #leaderboard-list li, 
        .dark-mode #profile-modal .modal-content #edit-profile-form input,
        .dark-mode #profile-stats p {
             background-color: #4a637d;
             color: #ecf0f1;
        }
        .dark-mode #profile-modal .modal-content #edit-profile-form input {
             border: 1px solid #7f8c8d;
             background-color: #34495e;
        }


        /* –ö—Ä–µ–¥–∏—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É */
        .sanwec-credit {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 1.2em;
            text-align: center;
            margin-top: 30px;
            background: linear-gradient(45deg, #ff0084, #3300ff, #00ff00, #ff0084);
            background-size: 400% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: text-flow 4s linear infinite;
        }
        
        @keyframes text-flow {
            to {
                background-position: 400% center;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>BLOCK BLAST</h1>
        
        <div class="header-buttons">
            <button id="auth-button" class="game-button" style="background-image: linear-gradient(to right, #2196F3 0%, #03A9F4 100%);">–í—Ö–æ–¥/–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <button id="leaderboard-button" class="game-button" style="background-image: linear-gradient(to right, #FF9800 0%, #FFC107 100%);">–õ–∏–¥–µ—Ä—ã üèÜ</button>
            <button id="reset-button" 
                /* –ö–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ" */
                class="game-button">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
        </div>

        <div class="score-panel">
            –°—á–µ—Ç: <span id="score">0</span>
            <div id="mode-info">–û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º.</div>
            <div id="combo-display"></div>
        </div>

        <div id="game-board">
        /* –Ø—á–µ–π–∫–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã JS */ 
        </div>

        <div class="next-blocks-panel">
   
            <h3>–°–ª–µ–¥—É—é—â–∏–µ —Ñ–∏–≥—É—Ä—ã:</h3>
            <div id="next-blocks">
                </div>
        </div>
        
        <div class="header-buttons">
            <button 
                id="mode-button" class="game-button">–†–µ–∂–∏–º –ò–≥—Ä—ã üïπÔ∏è</button>
            /* –ö–Ω–æ–ø–∫–∞ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" */ 
            <button id="settings-button" class="game-button" style="background-image: linear-gradient(to right, #ff7675 0%, #e84393 100%);">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚öôÔ∏è</button>
        </div>
    </div>
    
    <div id="mode-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="mode">&times;</span>
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ –†–µ–∂–∏–º –ò–≥—Ä—ã</h2>
  
            <hr 
                style="border-color: #ccc; margin-bottom: 20px;">
            
            <button class="mode-selection-button active" data-mode="normal">
                **–û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º**
                <br><span style="font-size: 0.8em;
                color: inherit;">–°—á–µ—Ç –∏–¥–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤.</span>
            </button>
            
            <button class="mode-selection-button" data-mode="training">
                **–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å –ò–ò-–ø–æ–¥—Å–∫–∞–∑—á–∏–∫–æ–º** ü§ñ
                <br><span style="font-size: 0.8em;
                color: inherit;">–ò–ò –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª—É—á—à–∏–π —Ö–æ–¥. –°—á–µ—Ç –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è.</span>
            </button>
            
            <button class="mode-selection-button" data-mode="ai_only">
                **–ò–ò –ø—Ä–æ—Ç–∏–≤ –ò–ò** ‚öîÔ∏è
                <br><span style="font-size: 0.8em;
                color: inherit;">–ù–∞–±–ª—é–¥–∞–π—Ç–µ, –∫–∞–∫ –ò–ò –∏–≥—Ä–∞–µ—Ç —Å–∞–º —Å —Å–æ–±–æ–π. –°—á–µ—Ç –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è.</span>
            </button>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="settings">&times;</span>
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–≥—Ä—ã</h2>
            <hr style="border-color: #ccc; margin-bottom: 20px;">
            
            <button id="theme-toggle-button" class="game-button" style="width: 100%; margin-bottom: 15px; background-image: linear-gradient(to right, #795548 0%, #A1887F 100%);">
                –°–º–µ–Ω–∏—Ç—å –¢–µ–º—É (–¢–µ–∫—É—â–∞—è: –°–≤–µ—Ç–ª–∞—è)
            </button>

            <p style="font-size: 1.1em; font-weight: 500; color: #ff6b6b; margin-bottom: 10px;">
                **–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ò–ò**
            </p>
            <div style="display: flex; justify-content: space-around; gap: 10px;">
                <button class="mode-selection-button active" data-difficulty="1" style="flex-grow: 1;">–£—Ä–æ–≤–µ–Ω—å 1 (–ë—ã—Å—Ç—Ä–æ)</button>
                <button class="mode-selection-button" data-difficulty="3" style="flex-grow: 1;">–£—Ä–æ–≤–µ–Ω—å 2 (–°—Ä–µ–¥–Ω–µ)</button>
                <button class="mode-selection-button" data-difficulty="5" style="flex-grow: 1;">–£—Ä–æ–≤–µ–Ω—å 3 (–ú–µ–¥–ª–µ–Ω–Ω–æ)</button>
            </div>
            
        </div>
    </div>
    
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="auth">&times;</span>
            <h2>–í—Ö–æ–¥ –∏–ª–∏ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <hr style="border-color: #ccc; margin-bottom: 20px;">
            
            <form id="auth-form" style="text-align: center;">
                <input type="email" id="auth-email" placeholder="Email" required style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; color: #333;">
                <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å" required style="width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; color: #333;">
                
                <p id="auth-message" style="margin-bottom: 10px; font-weight: 600; color: #e74c3c; min-height: 1.1em;"></p>
                
                <button type="submit" id="auth-submit" class="game-button" style="width: 100%; background-image: linear-gradient(to right, #6c5ce7 0%, #a29bfe 100%);">–í–æ–π—Ç–∏</button>
                <button type="button" id="toggle-register-button" class="game-button" style="width: 100%; margin-top: 5px; background-image: linear-gradient(to right, #2ecc71 0%, #27ae60 100%);">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            </form>
            
        </div>
    </div>
    
    <div id="leaderboard-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="leaderboard">&times;</span>
            <h2>–¢–∞–±–ª–∏—Ü–∞ –õ–∏–¥–µ—Ä–æ–≤</h2>
            <hr style="border-color: #ccc; margin-bottom: 20px;">
            
            <ul id="leaderboard-list">
                </ul>
        </div>
    </div>
    
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="profile">&times;</span>
            <h2 id="profile-nickname">–ü—Ä–æ—Ñ–∏–ª—å –ò–≥—Ä–æ–∫–∞</h2>
            <hr style="border-color: #ccc; margin-bottom: 20px;">
            
            <img id="profile-avatar" src="" alt="–ê–≤–∞—Ç–∞—Ä">
            
            <div id="profile-stats" style="text-align: center;">
                <p>–í—ã—Å—à–∏–π –°—á–µ—Ç: <strong id="profile-high-score">0</strong></p>
                <p>–°—ã–≥—Ä–∞–Ω–æ –ò–≥—Ä: <strong id="profile-games-played">0</strong></p>
            </div>
            
            <form id="edit-profile-form" style="display: none; margin-top: 15px;">
                <label for="edit-nickname-input" style="font-weight: 600; display: block; margin-top: 15px; margin-bottom: 5px;">–ù–æ–≤—ã–π –Ω–∏–∫–Ω–µ–π–º:</label>
                <input type="text" id="edit-nickname-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º" required minlength="3">
                <button type="submit" class="game-button" style="width: 100%; background-image: linear-gradient(to right, #4CAF50 0%, #8BC34A 100%);">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" id="cancel-edit-button" class="game-button" style="width: 100%; margin-top: 5px; background-image: linear-gradient(to right, #e74c3c 0%, #c0392b 100%);">–û—Ç–º–µ–Ω–∞</button>
            </form>
            
            <button type="button" id="edit-profile-button" class="game-button" style="width: 100%; display: none;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
            <p id="profile-message" style="margin-top: 15px; font-weight: 600; color: #e74c3c; min-height: 1.1em; text-align: center;"></p>
        </div>
    </div>
    
    <div class="sanwec-credit">
        –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ —Å –ª—é–±–æ–≤—å—é @sanwec | 2024
    </div>

    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase. –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò –ö–õ–Æ–ß–ò!
        const firebaseConfig = {
            apiKey: "...",
            authDomain: "...",
            projectId: "...",
            storageBucket: "...",
            messagingSenderId: "...",
            appId: "..."
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app(); // –µ—Å–ª–∏ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò–ì–†–´ ---
        const BOARD_SIZE = 8;
        const EMPTY_COLOR = 'transparent'; // –¶–≤–µ—Ç –ø—É—Å—Ç–æ–π —è—á–µ–π–∫–∏
        const NORMAL_MODE = 'normal';
        const TRAINING_MODE = 'training';
        const AI_ONLY_MODE = 'ai_only';
        
        let board = []; // –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ
        let score = 0;
        let gameMode = NORMAL_MODE;
        let comboCounter = 0;
        let currentShapes = []; // –¢–µ–∫—É—â–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∏–≥—É—Ä—ã
        let draggedShapeIndex = -1;
        let dragOffset = {row: 0, col: 0};
        let currentUser = null; // –¢–µ–∫—É—â–∏–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        let currentProfileUserId = null; // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á–µ–π –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç—Å—è
        let isRegistering = false; // –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        let isEditProfile = false; // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
        let aiDifficulty = 1; // –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ò–ò (1, 3, 5)
        let gameLoopInterval; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è —Ä–µ–∂–∏–º–∞ AI_ONLY
        
        // --- –ó–ê–©–ò–¢–ê –û–¢ –ß–ò–¢–û–í (–±–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å) ---
        let gameBoardStateHash = '';
        let scoreStateHash = '';
        
        // --- –î–ê–ù–ù–´–ï –ò–ò –ò –ü–û–î–°–í–ï–¢–ö–ò ---
        let currentBestPlacements = []; // –õ—É—á—à–∏–µ –º–µ—Å—Ç–∞ –¥–ª—è —Ñ–∏–≥—É—Ä, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ò–ò
        let lastHighlightedCells = []; // –°–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω—ã—Ö —è—á–µ–µ–∫
        
        // --- –≠–õ–ï–ú–ï–ù–¢–´ DOM ---
        const gameBoardElement = document.getElementById('game-board');
        const scoreElement = document.getElementById('score');
        const comboDisplayElement = document.getElementById('combo-display');
        const nextBlocksElement = document.getElementById('next-blocks');
        const resetButton = document.getElementById('reset-button');
        const modeButton = document.getElementById('mode-button');
        const settingsButton = document.getElementById('settings-button');
        const authButton = document.getElementById('auth-button');
        const leaderboardButton = document.getElementById('leaderboard-button');
        const modeInfoElement = document.getElementById('mode-info');

        // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        const modeModal = document.getElementById('mode-modal');
        const settingsModal = document.getElementById('settings-modal');
        const authModal = document.getElementById('auth-modal');
        const leaderboardModal = document.getElementById('leaderboard-modal');
        const profileModal = document.getElementById('profile-modal');
        
        const closeButtons = document.querySelectorAll('.close-button');
        const modeSelectionButtons = document.querySelectorAll('.mode-selection-button[data-mode]');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        const authForm = document.getElementById('auth-form');
        const authMessage = document.getElementById('auth-message');
        const toggleRegisterButton = document.getElementById('toggle-register-button');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ—Ñ–∏–ª—è
        const profileNicknameElement = document.getElementById('profile-nickname');
        const profileHighScoreElement = document.getElementById('profile-high-score');
        const profileGamesPlayedElement = document.getElementById('profile-games-played');
        const editProfileButton = document.getElementById('edit-profile-button');
        const editProfileForm = document.getElementById('edit-profile-form');
        const editNicknameInput = document.getElementById('edit-nickname-input');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const profileMessage = document.getElementById('profile-message');
        const profileAvatar = document.getElementById('profile-avatar');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫
        const difficultyButtons = document.querySelectorAll('.mode-selection-button[data-difficulty]');
        const themeToggleButton = document.getElementById('theme-toggle-button');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã —Ç–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤
        const leaderboardList = document.getElementById('leaderboard-list');

        // --- –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –§–ò–ì–£–† ---
        const SHAPES = [
            // 1x1
            { size: 1, color: '#ff6b6b', pattern: [[1]] },
            
            // 1x2, 2x1
            { size: 2, color: '#feca57', pattern: [[1,1]] },
            { size: 2, color: '#feca57', pattern: [[1],[1]] },
            
            // 2x2
            { size: 4, color: '#54a0ff', pattern: [[1,1],[1,1]] },
            // 1x3, 3x1
            { size: 3, color: '#1dd1a1', pattern: [[1,1,1]] },
            { size: 3, color: '#1dd1a1', pattern: [[1],[1],[1]] },
            
            // 1x4, 4x1
            { size: 4, color: '#a29bfe', pattern: [[1,1,1,1]] },
            { size: 4, color: '#a29bfe', pattern: [[1],[1],[1],[1]] },
            
            // L-–æ–±—Ä–∞–∑–Ω—ã–µ (3x2, 2x3)
            { size: 3, color: '#ff9f43', pattern: [[1,0],[1,0],[1,1]] }, // L
            { size: 3, color: '#ff9f43', pattern: [[1,1,1],[1,0,0]] }, // L –ø–æ–≤–µ—Ä–Ω—É—Ç–∞—è
            
            // T-–æ–±—Ä–∞–∑–Ω—ã–µ
            { size: 4, color: '#ff7675', pattern: [[0,1,0],[1,1,1],[0,0,0]] }, // T
            
            // Z/S-–æ–±—Ä–∞–∑–Ω—ã–µ
            { size: 5, color: '#ffb8b8', pattern: [[1,1,0],[0,1,0],[0,1,1]] }, // S
            
            // Z-–æ–±—Ä–∞–∑–Ω—ã–µ (2x3)
            { size: 4, color: '#fd79a8', pattern: [[1,1,0],[0,1,1]] },
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è L
            { size: 4, color: '#2d3436', pattern: [[1,1],[0,1],[0,1]] }
        ];

        // --- –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ì–†–´ ---

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ.
         */
        function generateBoard() {
            board = [];
            gameBoardElement.innerHTML = '';
            for (let r = 0; r < BOARD_SIZE; r++) {
                board[r] = [];
                for (let c = 0; c < BOARD_SIZE; c++) {
                    board[r][c] = EMPTY_COLOR;
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    gameBoardElement.appendChild(cell);
                }
            }
        }

        /**
         * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å —Ñ–∏–≥—É—Ä—É.
         */
        function canPlaceShape(pattern, startR, startC) {
            for (let r = 0; r < pattern.length; r++) {
                for (let c = 0; c < pattern[0].length; c++) {
                    if (pattern[r][c] === 1) {
                        const boardR = startR + r;
                        const boardC = startC + c;

                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—ã—Ö–æ–¥ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
                        if (boardR < 0 || boardR >= BOARD_SIZE || boardC < 0 || boardC >= BOARD_SIZE) {
                            return false;
                        }
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç—å —è—á–µ–π–∫–∏
                        if (board[boardR][boardC] !== EMPTY_COLOR) {
                            return false;
                        }
                    }
                }
            }
            return true;
        }

        /**
         * –†–∞–∑–º–µ—â–∞–µ—Ç —Ñ–∏–≥—É—Ä—É –Ω–∞ –ø–æ–ª–µ.
         */
        function placeShape(shapeData, startR, startC) {
            const pattern = shapeData.pattern;
            const color = shapeData.color;
            let cellsAffected = 0; 

            for (let r = 0; r < pattern.length; r++) {
                for (let c = 0; c < pattern[0].length; c++) {
                    if (pattern[r][c] === 1) {
                        const boardR = startR + r;
                        const boardC = startC + c;

                        board[boardR][boardC] = color;
                        const cell = gameBoardElement.querySelector(`[data-row="${boardR}"][data-col="${boardC}"]`);
                        if (cell) {
                            cell.classList.add('filled');
                            cell.style.backgroundColor = color;
                            cellsAffected++;
                        }
                    }
                }
            }
            
            updateScore(cellsAffected, false, 0); // –î–æ–±–∞–≤–ª—è–µ–º –æ—á–∫–∏ –∑–∞ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏
            
            protectGameVariables();
        }

        /**
         * –í–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—á–∏—Å—Ç–∫—É –ª–∏–Ω–∏–π.
         */
        function clearLines(cellsToClear) {
            if (cellsToClear.size === 0) {
                return;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏
            cellsToClear.forEach(key => {
                const [r, c] = key.split('-').map(Number);
                const cell = gameBoardElement.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                if (cell) {
                    cell.classList.add('clearing');
                }
            });

            // –ü–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –æ—á–∏—â–∞–µ–º —è—á–µ–π–∫–∏
            setTimeout(() => {
                cellsToClear.forEach(key => {
                    const [r, c] = key.split('-').map(Number);
                    const cell = gameBoardElement.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                    if (cell) {
                        cell.classList.remove('filled', 'clearing');
                        cell.style.backgroundColor = EMPTY_COLOR;
                        cell.style.opacity = '1';
                    }
                    board[r][c] = EMPTY_COLOR;
                });
                
                protectGameVariables();
            }, 400); // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏
        }

        /**
         * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –æ—á–∏—â–∞–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ª–∏–Ω–∏–∏ (—Ä—è–¥—ã –∏ —Å—Ç–æ–ª–±—Ü—ã).
         */
        function checkAndClearLines() {
            let clearedLines = 0;
            const cellsToClear = new Set(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º Set –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —è—á–µ–µ–∫

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–æ–∫
            for (let r = 0; r < BOARD_SIZE; r++) {
                let isRowFull = true;
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if (board[r][c] === EMPTY_COLOR) {
                        isRowFull = false;
                        break;
                    }
                }
                if (isRowFull) {
                    clearedLines++;
                    for (let c = 0; c < BOARD_SIZE; c++) cellsToClear.add(`${r}-${c}`);
                }
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–±—Ü–æ–≤
            for (let c = 0; c < BOARD_SIZE; c++) {
                let isColFull = true;
                for (let r = 0; r < BOARD_SIZE; r++) {
                    if (board[r][c] === EMPTY_COLOR) {
                        isColFull = false;
                        break;
                    }
                }
                if (isColFull) {
                    clearedLines++;
                    for(let r = 0; r < BOARD_SIZE; r++) cellsToClear.add(`${r}-${c}`);
                }
            }

            if (clearedLines > 0) {
                clearLines(cellsToClear);
                // –û—á–∫–∏ –∑–∞ –æ—á–∏—Å—Ç–∫—É: (–∫–æ–ª-–≤–æ –æ—á–∏—â–µ–Ω–Ω—ã—Ö —è—á–µ–µ–∫) + (–±–æ–Ω—É—Å –∑–∞ –∫–æ–º–±–æ)
                updateScore(clearedLines * BOARD_SIZE, false, clearedLines); 
            }
        }

        /**
         * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–æ–º–±–æ-—Å–æ–æ–±—â–µ–Ω–∏–µ.
         */
        function showCombo(count, reset = false) {
            if (reset || count <= 1) {
                comboDisplayElement.textContent = '';
                comboDisplayElement.style.opacity = '0';
                return;
            }
            
            comboDisplayElement.textContent = `üî• –ö–û–ú–ë–û x${count}!`;
            comboDisplayElement.style.opacity = '1';
            
            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä –∏ —Ü–≤–µ—Ç –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞
            comboDisplayElement.style.fontSize = `${1.1 + count * 0.1}em`;
            comboDisplayElement.style.color = count >= 3 ? '#ff4757' : '#e67e22'; // –±–æ–ª–µ–µ —è—Ä–∫–∏–π —Ü–≤–µ—Ç –¥–ª—è –±–æ–ª—å—à–∏—Ö –∫–æ–º–±–æ
        }

        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç –∏–≥—Ä–æ–≤–æ–π —Å—á–µ—Ç.
         */
        function updateScore(points, reset = false, linesCleared = 0) {
            if (reset) {
                score = points;
                comboCounter = 0;
                showCombo(0, true);
            } else {
                if (!validateGameVariables()) return; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —á–∏—Ç—ã

                let baseScore = points;
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–±–æ
                if (linesCleared > 0) {
                    comboCounter++;
                    baseScore += (comboCounter - 1) * 10; // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ—á–∫–∏ –∑–∞ –∫–æ–º–±–æ
                } else {
                    comboCounter = 0; // –°–±—Ä–æ—Å –∫–æ–º–±–æ, –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ –ª–∏–Ω–∏–π
                }
                
                showCombo(comboCounter);
                score += baseScore;
            }

            scoreElement.textContent = score;
        }

        /**
         * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 3 –Ω–æ–≤—ã–µ —Ñ–∏–≥—É—Ä—ã.
         */
        function generateNextShapes() {
            if (!validateGameVariables()) return; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —á–∏—Ç—ã

            nextBlocksElement.innerHTML = '';
            
            // –£–¥–∞–ª—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏–≥—É—Ä—ã (null)
            const remainingShapes = currentShapes.filter(s => s !== null);
            if (remainingShapes.length === 0) {
                currentShapes = [];
                for (let i = 0; i < 3; i++) {
                    const randomIndex = Math.floor(Math.random() * SHAPES.length);
                    currentShapes.push(SHAPES[randomIndex]);
                }
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –ª—É—á—à–∏–µ –º–µ—Å—Ç–∞ –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ–∏–≥—É—Ä (–¥–ª—è –ò–ò/–ü—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ü–∞ –∏–≥—Ä—ã)
            currentBestPlacements = [];
            for (let i = 0; i < 3; i++) {
                const shapeData = currentShapes[i];
                if (shapeData) {
                    const container = createShapeElement(shapeData, i);
                    nextBlocksElement.appendChild(container);
                    // –î–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ–π —Ñ–∏–≥—É—Ä—ã –∏—â–µ–º –ª—É—á—à–∏–π —Ö–æ–¥
                    currentBestPlacements.push(findBestPlacement(shapeData));
                } else {
                    currentBestPlacements.push(null);
                }
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏, –µ—Å–ª–∏ —ç—Ç–æ —Ä–µ–∂–∏–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
            if (gameMode === TRAINING_MODE) {
                showAllAIHighlights();
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Å—Ç—É–ø–∏–ª –ª–∏ –∫–æ–Ω–µ—Ü –∏–≥—Ä—ã —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            if (currentShapes.filter(s => s !== null).every((shape, index) => currentBestPlacements[index] === null)) {
                gameOver();
            }
            
            
            protectGameVariables();
        }

        /**
         * –°–æ–∑–¥–∞–µ—Ç HTML-—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ñ–∏–≥—É—Ä—ã.
         */
        function createShapeElement(shapeData, index) {
            const container = document.createElement('div');
            container.classList.add('shape-container');
            container.setAttribute('draggable', 'true'); // –î–µ–ª–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–º
            container.dataset.shapeIndex = index;

            const shapeDiv = document.createElement('div');
            shapeDiv.classList.add('shape');
            shapeDiv.style.gridTemplateColumns = `repeat(${shapeData.pattern[0].length}, 1fr)`;
            
            for (let r = 0; r < shapeData.pattern.length; r++) {
                for (let c = 0; c < shapeData.pattern[0].length; c++) {
                    if (shapeData.pattern[r][c] === 1) {
                        const block = document.createElement('div');
                        block.classList.add('block');
                        block.style.backgroundColor = shapeData.color;
                        block.dataset.row = r; // –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π —Ä—è–¥ –≤–Ω—É—Ç—Ä–∏ —Ñ–∏–≥—É—Ä—ã
                        block.dataset.col = c; // –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞ –≤–Ω—É—Ç—Ä–∏ —Ñ–∏–≥—É—Ä—ã
                        shapeDiv.appendChild(block);
                    } else {
                         // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –±–ª–æ–∫ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Ç–∫–∏
                        const emptyBlock = document.createElement('div');
                        emptyBlock.style.width = '22px';
                        emptyBlock.style.height = '22px';
                        shapeDiv.appendChild(emptyBlock);
                    }
                }
            }
            
            container.appendChild(shapeDiv);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è Drag and Drop (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π)
            container.ondragstart = handleDragStart;
            container.ondragend = handleDragEnd;
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è Touch (–º–æ–±–∏–ª—å–Ω—ã–µ)
            container.onmousedown = handleMouseDown;
            container.ontouchstart = handleTouchStart;

            return container;
        }

        /**
         * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω–µ—Ü –∏–≥—Ä—ã.
         */
        function gameOver() {
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—á–µ—Ç–∞ —Ç–æ–ª—å–∫–æ –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ
            if (gameMode === NORMAL_MODE && currentUser) {
                updateHighScore(score);
            }
            
            // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –æ—á–∏—Å—Ç–∫–∏
            setTimeout(() => {
                alert(`–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –í–∞—à —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç: ${score}`);
                initializeGame(gameMode); // –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É –≤ —Ç–æ–º –∂–µ —Ä–µ–∂–∏–º–µ
            }, 500); // 500–º—Å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ö–æ–¥–∞
        }
        
        /**
         * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ª–æ–≤–∏–µ –∫–æ–Ω—Ü–∞ –∏–≥—Ä—ã.
         */
        function isGameOver() {
            // –ï—Å–ª–∏ –Ω–∏ –¥–ª—è –æ–¥–Ω–æ–π –∏–∑ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Ñ–∏–≥—É—Ä –Ω–µ—Ç –º–µ—Å—Ç–∞
             if (currentShapes.filter(s => s !== null).every((shape, index) => currentBestPlacements[index] === null)) {
                gameOver();
            }
        }

        /**
         * –ù–∞—á–∏–Ω–∞–µ—Ç –Ω–æ–≤—É—é –∏–≥—Ä—É.
         */
        function initializeGame(mode) {
            if (!validateGameVariables()) return; 
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–∏–∫–ª –ò–ò, –µ—Å–ª–∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
            if (gameLoopInterval) clearInterval(gameLoopInterval);
            
            generateBoard();
            updateScore(0, true);
            currentShapes = []; // –°–±—Ä–æ—Å —Ñ–∏–≥—É—Ä
            currentBestPlacements = [];
            gameMode = mode;
            clearHighlight();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–∂–∏–º–µ
            modeInfoElement.textContent = 
                mode === NORMAL_MODE ? '–û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º.' :
                mode === TRAINING_MODE ? '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å –ò–ò-–ø–æ–¥—Å–∫–∞–∑—á–∏–∫–æ–º.' :
                '–ò–ò –ø—Ä–æ—Ç–∏–≤ –ò–ò.';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ" –≤ —Ä–µ–∂–∏–º–µ –ò–ò –ø—Ä–æ—Ç–∏–≤ –ò–ò
            document.getElementById('reset-button').style.display = 'block';
            
            if (gameMode === AI_ONLY_MODE) {
                 document.getElementById('reset-button').style.display = 'none';
                 // –ù–∞—á–∏–Ω–∞–µ–º —Ü–∏–∫–ª –ò–ò
                 runAIGameLoop();
            } else {
                 generateNextShapes();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É —Ä–µ–∂–∏–º–∞
            modeSelectionButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === gameMode) {
                    btn.classList.add('active');
                }
            });
            
            
            protectGameVariables(); // –ó–∞—â–∏—Ç–∞
        }
        
        // --- –§–£–ù–ö–¶–ò–ò –ó–ê–©–ò–¢–´ –û–¢ –ß–ò–¢–û–í ---
        
        /**
         * –°–æ–∑–¥–∞–µ—Ç —Ö—ç—à —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å–∫–∏ –∏ —Å—á–µ—Ç–∞.
         */
        function hashBoard(board) {
            let hash = '';
            for(let r = 0; r < BOARD_SIZE; r++) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É —Ü–≤–µ—Ç–∞ –∏–ª–∏ 'E' –¥–ª—è EMPTY_COLOR
                hash += board[r].map(c => c === EMPTY_COLOR ? 'E' : c.charAt(1)).join('');
            }
            
            // –ü—Ä–æ—Å—Ç–∞—è —Å—É–º–º–∞ —Å–∏–º–≤–æ–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤ –¥–ª—è —Ö—ç—à–∞
            let charCodeSum = 0;
            for(let i = 0; i < hash.length; i++) {
                charCodeSum = (charCodeSum + hash.charCodeAt(i)) % 1000003; // –ü—Ä–æ—Å—Ç–æ–µ —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
            }
            return charCodeSum.toString(16) + score.toString(16); // –î–æ–±–∞–≤–ª—è–µ–º —Ö—ç—à —Å—á–µ—Ç–∞
        }

        /**
         * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â–∏–µ —Ö—ç—à–∏.
         */
        function protectGameVariables() {
            gameBoardStateHash = hashBoard(board);
            scoreStateHash = score.toString(16);
        }

        /**
         * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã.
         * @returns {boolean} true, –µ—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∞–ª–∏–¥–Ω–æ, false, –µ—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ —á–∏—Ç–µ—Ä—Å—Ç–≤–æ.
         */
        function validateGameVariables() {
            const currentBoardHash = hashBoard(board);
            const currentScoreHash = score.toString(16);

            if (currentBoardHash !== gameBoardStateHash || currentScoreHash !== scoreStateHash) {
                blockUser('–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–≥—Ä–æ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è. –í–∞—à —Å—á–µ—Ç –Ω–µ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω.');
                return false;
            }
            return true;
        }

        /**
         * –ë–ª–æ–∫–∏—Ä—É–µ—Ç –∏–≥—Ä—É –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —á–∏—Ç–æ–≤.
         */
        function blockUser(reason = '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –∫–æ–Ω—Å–æ–ª—å—é –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–≥—Ä—ã.') {
            const gameContainer = document.querySelector('.game-container');
            
            gameContainer.style.pointerEvents = 'none';
            gameContainer.style.opacity = '0.1';

            // –ü–æ–ª–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —ç–∫—Ä–∞–Ω–∞
            document.body.innerHTML = `
                <div style="text-align: center; color: #ff6b6b; padding: 50px; background-color: #ffffff; border-radius: 15px; box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);">
                    <h2>‚õî –ë–õ–û–ö–ò–†–û–í–ö–ê –ò–ì–†–´</h2>
                    <p style="font-size: 1.1em;">${reason}</p>
                    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>
                </div>
            `;
            
            if (gameLoopInterval) clearInterval(gameLoopInterval);
        }

        // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò DRAG & DROP –ò TOUCH (–µ–¥–∏–Ω—ã–π –ø–æ–¥—Ö–æ–¥) ---
        
        /**
         * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–º–µ—â–µ–Ω–∏–µ –º–µ–∂–¥—É —Ç–æ—á–∫–æ–π –∫–ª–∏–∫–∞/–∫–∞—Å–∞–Ω–∏—è –∏ –≤–µ—Ä—Ö–Ω–µ–π –ª–µ–≤–æ–π —è—á–µ–π–∫–æ–π —Ñ–∏–≥—É—Ä—ã.
         */
        function getShapeOffset(shapeElement, shapePattern, event) {
            const shapeBlocks = shapeElement.querySelectorAll('.block');
            let offsetX = 0;
            let offsetY = 0;
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞/–∫–∞—Å–∞–Ω–∏—è
            const clientX = event.clientX || (event.touches ? event.touches[0].clientX : 0);
            const clientY = event.clientY || (event.touches ? event.touches[0].clientY : 0);

            // –ù–∞—Ö–æ–¥–∏–º –±–ª–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –±–ª–∏–∂–µ –≤—Å–µ–≥–æ –∫ —Ç–æ—á–∫–µ –∫–∞—Å–∞–Ω–∏—è (–ª—É—á—à–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
            let closestBlock = null;
            let minDistance = Infinity;

            for (const block of shapeBlocks) {
                const rect = block.getBoundingClientRect();
                const dist = Math.sqrt(
                    Math.pow(clientX - (rect.left + rect.width / 2), 2) +
                    Math.pow(clientY - (rect.top + rect.height / 2), 2)
                );

                if (dist < minDistance) {
                    minDistance = dist;
                    closestBlock = block;
                }
            }

            if (closestBlock) {
                // –°–º–µ—â–µ–Ω–∏–µ - —ç—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±–ª–æ–∫–∞ –≤–Ω—É—Ç—Ä–∏ —Ñ–∏–≥—É—Ä—ã
                dragOffset.row = parseInt(closestBlock.dataset.row);
                dragOffset.col = parseInt(closestBlock.dataset.col);
            } else {
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ (—Ä–µ–∑–∫–∏–π —Å–¥–≤–∏–≥), –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é —è—á–µ–π–∫—É —Ñ–∏–≥—É—Ä—ã
                for (let r = 0; r < shapePattern.length; r++) {
                    for (let c = 0; c < shapePattern[0].length; c++) {
                        if (shapePattern[r][c] === 1) {
                            dragOffset.row = r;
                            dragOffset.col = c;
                            return;
                        }
                    }
                }
            }
        }
        
        /**
         * –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è (–¥–ª—è mouse down –∏ touch start).
         */
        function handleMouseDown(event) {
            const container = event.currentTarget;
            if (container.getAttribute('draggable') !== 'true') return;
            
            // –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ touch, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–∫—Ä–æ–ª–ª–∞
            if (event.type.startsWith('touch')) {
                event.preventDefault();
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            const shapeIndex = parseInt(container.dataset.shapeIndex);
            draggedShapeIndex = shapeIndex;
            
            const shapeData = currentShapes[shapeIndex];
            if (!shapeData) return;
            
            getShapeOffset(container, shapeData.pattern, event);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä—ã—Ç–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è
            container.classList.add('is-dragging');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è MouseMove/Up
            document.onmousemove = handleMouseMove;
            document.onmouseup = handleMouseUp;

            // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ò–ò, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –º–µ—à–∞–ª–∏
            clearHighlight();
        }
        
        /**
         * –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –¥–ª—è Touch.
         */
        function handleTouchStart(event) {
            handleMouseDown(event); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é –ª–æ–≥–∏–∫—É
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è TouchMove/End
            document.ontouchmove = handleTouchMove;
            document.ontouchend = handleTouchEnd;
        }

        /**
         * –î–≤–∏–∂–µ–Ω–∏–µ –º—ã—à–∏ (–¥–ª—è Mouse Down/Up).
         */
        function handleMouseMove(event) {
            event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
            if (draggedShapeIndex === -1) return;
            
            // –ù–∞—Ö–æ–¥–∏–º —è—á–µ–π–∫—É –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
            const targetCell = document.elementFromPoint(event.clientX, event.clientY);
            const boardCell = targetCell ? targetCell.closest('.cell') : null;
            
            if (boardCell) {
                handleDragOverInternal(boardCell);
            } else {
                clearPreview();
            }
        }
        
        /**
         * –î–≤–∏–∂–µ–Ω–∏–µ –∫–∞—Å–∞–Ω–∏—è (–¥–ª—è Touch Start/End).
         */
        function handleTouchMove(event) {
             if (draggedShapeIndex === -1) return;
             if (event.touches.length !== 1) return;
             
             // –ù–∞—Ö–æ–¥–∏–º —è—á–µ–π–∫—É –ø–æ–¥ –∫–∞—Å–∞–Ω–∏–µ–º
             const touch = event.touches[0];
             const targetCell = document.elementFromPoint(touch.clientX, touch.clientY);
             const boardCell = targetCell ? targetCell.closest('.cell') : null;
             
             if (boardCell) {
                 handleDragOverInternal(boardCell);
             } else {
                 clearPreview();
             }
        }
        
        /**
         * –û–∫–æ–Ω—á–∞–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è (–¥–ª—è Mouse Down/Up).
         */
        function handleMouseUp(event) {
            if (draggedShapeIndex === -1) return;
            
            // –ù–∞—Ö–æ–¥–∏–º —è—á–µ–π–∫—É –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è
            const targetCell = document.elementFromPoint(event.clientX, event.clientY);
            const boardCell = targetCell ? targetCell.closest('.cell') : null;
            
            if (boardCell) {
                handleDropInternal(boardCell);
            } else {
                // –ï—Å–ª–∏ –æ—Ç–ø—É—Å—Ç–∏–ª–∏ –≤–Ω–µ –ø–æ–ª—è
                handleDragEndInternal();
            }
            
            // –£–¥–∞–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            document.onmousemove = null;
            document.onmouseup = null;
        }
        
        /**
         * –û–∫–æ–Ω—á–∞–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è (–¥–ª—è Touch Start/End).
         */
        function handleTouchEnd(event) {
            if (draggedShapeIndex === -1) return;
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–ø—É—â–µ–Ω–Ω–æ–≥–æ –∫–∞—Å–∞–Ω–∏—è
            const changedTouch = event.changedTouches[0];
            
            // –ù–∞—Ö–æ–¥–∏–º —è—á–µ–π–∫—É –ø–æ–¥ –∫–∞—Å–∞–Ω–∏–µ–º
            const targetCell = document.elementFromPoint(changedTouch.clientX, changedTouch.clientY);
            const boardCell = targetCell ? targetCell.closest('.cell') : null;
            
            if (boardCell) {
                handleDropInternal(boardCell);
            } else {
                // –ï—Å–ª–∏ –æ—Ç–ø—É—Å—Ç–∏–ª–∏ –≤–Ω–µ –ø–æ–ª—è
                handleDragEndInternal();
            }
            
            // –£–¥–∞–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            document.ontouchmove = null;
            document.ontouchend = null;
        }

        
        
        // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò DRAG & DROP (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π) ---
        
        function handleDragStart(event) {
            // –ü–µ—Ä–µ–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å —Ñ–∏–≥—É—Ä—ã
            event.dataTransfer.setData('text/plain', event.target.closest('.shape-container').dataset.shapeIndex);
            
            const shapeContainer = event.target.closest('.shape-container');
            const shapeIndex = parseInt(shapeContainer.dataset.shapeIndex);
            draggedShapeIndex = shapeIndex;
            
            const shapeData = currentShapes[shapeIndex];
            if (!shapeData) return;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            getShapeOffset(shapeContainer, shapeData.pattern, event);

            // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã Drag Image
            setTimeout(() => shapeContainer.classList.add('is-dragging'), 0);
            
            // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ò–ò
            clearHighlight();
        }

        /**
         * –û–±—â–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è.
         */
        function handleDragEndInternal() {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            const container = document.querySelector(`.shape-container[data-shape-index="${draggedShapeIndex}"]`);
            if (container) {
                container.classList.remove('is-dragging');
            }
            clearPreview();
            draggedShapeIndex = -1;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏, –µ—Å–ª–∏ –≤ —Ä–µ–∂–∏–º–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
            if (gameMode === TRAINING_MODE) {
                showAllAIHighlights();
            }
        }
        
        function handleDragEnd(event) {
             const shapeContainer = event.target.closest('.shape-container');
             // –í–∏–∑—É–∞–ª—å–Ω—ã–π —Å–±—Ä–æ—Å
             shapeContainer.classList.remove('is-dragging');
             clearPreview();
             draggedShapeIndex = -1;
             
             // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏
             if (gameMode === TRAINING_MODE) {
                showAllAIHighlights();
            }
        }

        /**
         * –û–±—â–∞—è –ª–æ–≥–∏–∫–∞ Drag Over / Mouse Move.
         */
        function handleDragOverInternal(targetCell) {
            if (!targetCell || draggedShapeIndex === -1) return;
            const cellRow = parseInt(targetCell.dataset.row);
            const cellCol = parseInt(targetCell.dataset.col);
            
            // –í—ã—á–∏—Å–ª—è–µ–º –≤–µ—Ä—Ö–Ω—é—é –ª–µ–≤—É—é —Ç–æ—á–∫—É —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º —Å–º–µ—â–µ–Ω–∏—è
            const startRow = cellRow - dragOffset.row;
            const startCol = cellCol - dragOffset.col;
            
            const shapeData = currentShapes[draggedShapeIndex];
            if (!shapeData) return;
            
            previewPlacement(shapeData, startRow, startCol);
        }

        function handleDragOver(event) {
            event.preventDefault(); // –†–∞–∑—Ä–µ—à–∞–µ–º —Å–±—Ä–æ—Å
            const targetCell = event.target.closest('.cell');
            
            if (!targetCell || draggedShapeIndex === -1) return;
            handleDragOverInternal(targetCell);
        }

        function handleDragEnter(event) {
            event.preventDefault();
        }
        
        function function handleDragLeave(event) {
            // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–≤—å—é, –∫–æ–≥–¥–∞ –∫—É—Ä—Å–æ—Ä —É—Ö–æ–¥–∏—Ç —Å –ø–æ–ª—è
            if (event.target.id === 'game-board' || event.target.closest('#game-board')) {
                 // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø–æ–∫–∏–¥–∞–µ–º –∏–º–µ–Ω–Ω–æ –ø–æ–ª–µ
                if (event.relatedTarget && !event.relatedTarget.closest('#game-board')) {
                    clearPreview();
                }
            }
        }

        /**
         * –û–±—â–∞—è –ª–æ–≥–∏–∫–∞ Drop / Mouse Up.
         */
        function handleDropInternal(targetCell) {
            clearPreview(); // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–≤—å—é
            if (!targetCell || draggedShapeIndex === -1) {
                handleDragEndInternal();
                return;
            }

            const cellRow = parseInt(targetCell.dataset.row);
            const cellCol = parseInt(targetCell.dataset.col);
            
            // –í—ã—á–∏—Å–ª—è–µ–º –≤–µ—Ä—Ö–Ω—é—é –ª–µ–≤—É—é —Ç–æ—á–∫—É —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º —Å–º–µ—â–µ–Ω–∏—è
            const startRow = cellRow - dragOffset.row;
            const startCol = cellCol - dragOffset.col;
            
            const shapeIndex = draggedShapeIndex;
            const shapeData = currentShapes[shapeIndex];
            
            if (!shapeData) {
                handleDragEndInternal();
                return;
            }

            // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å
            if (canPlaceShape(shapeData.pattern, startRow, startCol)) {
                placeShape(shapeData, startRow, startCol);
                currentShapes[shapeIndex] = null; // –£–¥–∞–ª—è–µ–º —Ñ–∏–≥—É—Ä—É –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö

                // –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–∏–≥—É—Ä—ã –∏–∑ DOM
                const container = document.querySelector(`.shape-container[data-shape-index="${shapeIndex}"]`);
                if(container) container.remove();

                checkAndClearLines();
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Ñ–∏–≥—É—Ä—ã, –µ—Å–ª–∏ –≤—Å–µ –±—ã–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã
                if (currentShapes.every(s => s === null)) {
                    generateNextShapes();
                } else if (gameMode === TRAINING_MODE) {
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ª—É—á—à–∏–µ —Ö–æ–¥—ã –¥–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Ñ–∏–≥—É—Ä
                    currentBestPlacements = currentShapes.map(s => s ? findBestPlacement(s) : null);
                    showAllAIHighlights();
                }

                isGameOver();
            } else {
                // –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å, –ø—Ä–æ—Å—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
                handleDragEndInternal();
            }
            
            draggedShapeIndex = -1; // –°–±—Ä–æ—Å –∏–Ω–¥–µ–∫—Å–∞
        }

        function handleDrop(event) {
            event.preventDefault();
            clearPreview();
            
            const targetCell = event.target.closest('.cell');
            if (!targetCell) return;
            
            handleDropInternal(targetCell);
        }

        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ–µ –ø—Ä–µ–≤—å—é —Ä–∞–∑–º–µ—â–µ–Ω–∏—è.
         */
        function previewPlacement(shapeData, startR, startC) {
            
            clearPreview();

            const pattern = shapeData.pattern;
            
            if (canPlaceShape(pattern, startR, startC)) {
                // –ú–æ–∂–Ω–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–≥—É—Ä—É –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º —Ü–≤–µ—Ç–æ–º
                for (let r = 0; r < pattern.length; r++) {
                    for (let c = 0; c < pattern[0].length; c++) {
                        if (pattern[r][c] === 1) {
                            const boardR = startR + r;
                            const boardC = startC + c;

                            const cell = gameBoardElement.querySelector(`[data-row="${boardR}"][data-col="${boardC}"]`);
                            if (cell) {
                                
                                cell.style.opacity = '0.5';
                                cell.style.backgroundColor = shapeData.color;
                                cell.classList.add('preview');
                            }
                        }
                    }
                }
            } else {
                 // –ù–µ–ª—å–∑—è —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å: –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫—Ä–∞—Å–Ω—ã–º —Ç–µ –º–µ—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ –º–µ—à–∞—é—Ç
                 for (let r = 0; r < pattern.length; r++) {
                    for (let c = 0; c < pattern[0].length; c++) {
                        if (pattern[r][c] === 1) {
                            const boardR = startR + r;
                            const boardC = startC + c;
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ —è—á–µ–π–∫–∏ –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª—è
                            if (boardR >= 0 && boardR < BOARD_SIZE && boardC >= 0 && boardC < BOARD_SIZE) {
                                const cell = gameBoardElement.querySelector(`[data-row="${boardR}"][data-col="${boardC}"]`);
                                if (cell) {
                                    if (board[boardR][boardC] === EMPTY_COLOR) {
                                        // –Ø—á–µ–π–∫–∞ –ø—É—Å—Ç–∞, –Ω–æ —Ñ–∏–≥—É—Ä–∞ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∏–ª–∏ –Ω–∞–µ–∑–∂–∞–µ—Ç –Ω–∞ –¥—Ä—É–≥—É—é —Ñ–∏–≥—É—Ä—É (–∫—Ä–∞—Å–Ω–æ–µ –ø—Ä–µ–≤—å—é)
                                        cell.style.opacity = '0.3';
                                        cell.style.backgroundColor = 'red';
                                        cell.classList.add('preview');
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        /**
         * –£–±–∏—Ä–∞–µ—Ç –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–µ–≤—å—é.
         */
        function clearPreview() {
            gameBoardElement.querySelectorAll('.cell.preview').forEach(cell => {
                // –ï—Å–ª–∏ —è—á–µ–π–∫–∞ –±—ã–ª–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞, –µ–µ —Ü–≤–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∏–∑ .filled —Å—Ç–∏–ª—è
                // –ï—Å–ª–∏ –Ω–µ—Ç, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º EMPTY_COLOR
                if (!cell.classList.contains('filled')) {
                    cell.style.opacity = '1';
                    cell.style.backgroundColor = EMPTY_COLOR; 
                }
                cell.classList.remove('preview');
            });
        }
        
        // --- –§–£–ù–ö–¶–ò–ò –ò–°–ö–£–°–°–¢–í–ï–ù–ù–û–ì–û –ò–ù–¢–ï–õ–õ–ï–ö–¢–ê (AI) ---
        
        /**
         * –û—Ü–µ–Ω–æ—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å–∫–∏.
         * –ß–µ–º –≤—ã—à–µ —Å—á–µ—Ç, —Ç–µ–º –ª—É—á—à–µ.
         */
        function evaluateBoard(board, clearedLines) {
            if (!validateGameVariables()) return -Infinity; 
            
            let score = 0;
            let occupiedCells = 0;

            // 1. –®—Ç—Ä–∞—Ñ –∑–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —è—á–µ–π–∫–∏ (–º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏)
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if (board[r][c] !== EMPTY_COLOR) {
                        occupiedCells++;
                    }
                }
            }

            // 2. –ë–æ–Ω—É—Å –∑–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –æ—á–∏—Å—Ç–∫–∏ (—Ä—è–¥—ã/—Å—Ç–æ–ª–±—Ü—ã —Å 7/6 –±–ª–æ–∫–∞–º–∏)
            let potentialClears = 0;
            
            // –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä—è–¥–æ–≤
            for (let r = 0; r < BOARD_SIZE; r++) {
                let filledInRow = 0;
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if (board[r][c] !== EMPTY_COLOR) filledInRow++;
                }
                if (filledInRow === BOARD_SIZE - 1) {
                    potentialClears += 2; // –û—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ
                } else if (filledInRow === BOARD_SIZE - 2) {
                    potentialClears += 1; // –•–æ—Ä–æ—à–æ
                }
            }
            
            // –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª —Å—Ç–æ–ª–±—Ü–æ–≤
            for (let c = 0; c < BOARD_SIZE; c++) {
                let filledInCol = 0;
                for (let r = 0; r < BOARD_SIZE; r++) {
                    if (board[r][c] !== EMPTY_COLOR) filledInCol++;
                }
                if (filledInCol === BOARD_SIZE - 1) {
                    potentialClears += 2;
                } else if (filledInCol === BOARD_SIZE - 2) {
                    potentialClears += 1;
                }
            }

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–µ—Å–∞
            score -= occupiedCells * 1; // –ú–∏–Ω—É—Å 1 –æ—á–∫–æ –∑–∞ –∫–∞–∂–¥—ã–π –∑–∞–Ω—è—Ç—ã–π –±–ª–æ–∫

            // –ë–æ–Ω—É—Å –∑–∞ –æ—á–∏—Å—Ç–∫—É
            if (clearedLines > 0) {
                // –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π –±–æ–Ω—É—Å –∑–∞ –æ—á–∏—Å—Ç–∫—É, —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∑–∞ –∫–æ–º–±–æ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ª–∏–Ω–∏–∏)
                score += clearedLines * BOARD_SIZE * Math.pow(1.5, clearedLines - 1) * 3;
            }
            
            // –ë–æ–Ω—É—Å –∑–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª
            score += potentialClears * 0.5;

            return score;
        }

        
        /**
         * –°–∏–º—É–ª–∏—Ä—É–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Ñ–∏–≥—É—Ä—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏.
         */
        function simulatePlacement(board, shapeData, startR, startC) {
            const tempCells = JSON.parse(JSON.stringify(board)); // –ö–ª–æ–Ω–∏—Ä—É–µ–º –¥–æ—Å–∫—É
            const pattern = shapeData.pattern;
            const color = shapeData.color;
            let cellsAffected = 0;

            if (!canPlaceShape(pattern, startR, startC)) {
                return { board: null, clearedLines: 0, scoreIncrease: 0 };
            }

            // 1. –†–∞–∑–º–µ—â–µ–Ω–∏–µ —Ñ–∏–≥—É—Ä—ã
            for (let r = 0; r < pattern.length; r++) {
                for (let c = 0; c < pattern[0].length; c++) {
                    if (pattern[r][c] === 1) {
                        tempCells[startR + r][startC + c] = color;
                        cellsAffected++;
                    }
                }
            }

            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–æ–¥—Å—á–µ—Ç –æ—á–∏—â–µ–Ω–Ω—ã—Ö –ª–∏–Ω–∏–π
            let clearedLines = 0;
            const cellsToClear = new Set();

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–æ–∫
            for (let r = 0; r < BOARD_SIZE; r++) {
                if (tempCells[r].every(c => c !== EMPTY_COLOR)) {
                    clearedLines++;
                    for (let c = 0; c < BOARD_SIZE; c++) cellsToClear.add(`${r}-${c}`);
                }
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–±—Ü–æ–≤
            for (let c = 0; c < BOARD_SIZE; c++) {
                let isColFull = true;
                for (let r = 0; r < BOARD_SIZE; r++) {
                    if (tempCells[r][c] === EMPTY_COLOR) {
                        isColFull = false;
                        break;
                    }
                }
                if (isColFull) {
                    clearedLines++;
                    for(let r = 0; r < BOARD_SIZE; r++) cellsToClear.add(`${r}-${c}`);
                }
            }

            // 3. –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–π –¥–æ—Å–∫–∏ (—Å –æ—á–∏—â–µ–Ω–Ω—ã–º–∏ –ª–∏–Ω–∏—è–º–∏)
            const nextBoard = JSON.parse(JSON.stringify(tempCells));
            if (clearedLines > 0) {
                cellsToClear.forEach(key => {
                    const [r, c] = key.split('-').map(Number);
                    nextBoard[r][c] = EMPTY_COLOR;
                });
            }

            // –ü–æ–¥—Å—á–µ—Ç —É–≤–µ–ª–∏—á–µ–Ω–∏—è –æ—á–∫–æ–≤ (–¥–ª—è —É—á–µ—Ç–∞ –≤ –æ—Ü–µ–Ω–∫–µ)
            const scoreIncrease = cellsAffected + (clearedLines > 0 ? clearedLines * BOARD_SIZE * clearedLines : 0);

            return { board: nextBoard, clearedLines: clearedLines, scoreIncrease: scoreIncrease };
        }


        /**
         * –ù–∞—Ö–æ–¥–∏—Ç –ª—É—á—à–µ–µ –º–µ—Å—Ç–æ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ–¥–Ω–æ–π —Ñ–∏–≥—É—Ä—ã.
         * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Å—Ç—É—é –∂–∞–¥–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é (Greedy Search) —Å –≥–ª—É–±–∏–Ω–æ–π 1.
         */
        function findBestPlacement(shapeData) {
            let bestScore = -Infinity;
            let bestPlacement = null;
            
            // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ –ø–æ–∏—Å–∫–∞
            let maxDepth = aiDifficulty; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–ª–æ–∂–Ω–æ—Å—Ç—å

            // –ü–µ—Ä–µ–±–æ—Ä –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    const result = simulatePlacement(board, shapeData, r, c);

                    if (result.board) {
                        
                        let currentScore = evaluateBoard(result.board, result.clearedLines) + result.scoreIncrease * 10;
                        
                        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏ (–±–æ–ª—å—à–∞—è –≥–ª—É–±–∏–Ω–∞) –º–æ–∂–µ—Ç —Å–∏–ª—å–Ω–æ –∑–∞–º–µ–¥–ª–∏—Ç—å –∏–≥—Ä—É
                        if (maxDepth > 1) {
                            // –ó–¥–µ—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ (minimax/monte-carlo)
                        }

                        if (currentScore > bestScore) {
                            bestScore = currentScore;
                            bestPlacement = { startR: r, startC: c };
                        }
                    }
                }
            }

            return bestPlacement; // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç { startR: r, startC: c } –∏–ª–∏ null
        }

        
        // --- –§–£–ù–ö–¶–ò–ò –ü–û–î–°–í–ï–¢–ö–ò –ò–ò ---
        
        /**
         * –£–¥–∞–ª—è–µ—Ç –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å –¥–æ—Å–∫–∏.
         */
        function clearHighlight() {
            lastHighlightedCells.forEach(cell => {
                cell.classList.remove('ai-highlight-0', 'ai-highlight-1', 'ai-highlight-2');
                cell.style.boxShadow = '';
                cell.style.border = '1px solid #b2bec3';
            });
            lastHighlightedCells = [];
            
            // –£–¥–∞–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Ñ–∏–≥—É—Ä
            document.querySelectorAll('.shape-container').forEach(c => {
                 c.classList.remove('ai-target-0', 'ai-target-1', 'ai-target-2');
            });
        }
        
        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥—Å–≤–µ—Ç–∫—É –¥–ª—è –æ–¥–Ω–æ–π –ª—É—á—à–µ–π –ø–æ–∑–∏—Ü–∏–∏.
         * (–í –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ showAllAIHighlights, –Ω–æ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –ø—Ä–∏–≥–æ–¥–∏—Ç—å—Å—è).
         */
        function highlightAI(placement, shapeData, index) {
            clearHighlight();
            
            const startR = placement.startR;
            const startC = placement.startC;
            const pattern = shapeData.pattern;
            const colorClass = `ai-highlight-${index}`;
            const targetClass = `ai-target-${index}`;
            
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–∏–≥—É—Ä—ã
            const shapeContainer = document.querySelector(`.shape-container[data-shape-index="${index}"]`);
            if (shapeContainer) {
                 shapeContainer.classList.add(targetClass);
            }

            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —è—á–µ–π–∫–∏ –Ω–∞ –¥–æ—Å–∫–µ
            for (let r = 0; r < pattern.length; r++) {
                for (let c = 0; c < pattern[0].length; c++) {
                    if (pattern[r][c] === 1) {
                        const boardR = startR + r;
                        const boardC = startC + c;
                        
                        const cell = gameBoardElement.querySelector(`[data-row="${boardR}"][data-col="${boardC}"]`);
                        if (cell) {
                            cell.classList.add(colorClass);
                            lastHighlightedCells.push(cell);
                        }
                    }
                }
            }
        }
        
        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥—Å–≤–µ—Ç–∫—É –¥–ª—è –≤—Å–µ—Ö —Ç—Ä–µ—Ö —Ç–µ–∫—É—â–∏—Ö —Ñ–∏–≥—É—Ä.
         */
        function showAllAIHighlights() {
            clearHighlight(); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ
            
            // –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å—ã –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            document.querySelectorAll('.shape-container').forEach(c => {
                 c.classList.remove('ai-target-0', 'ai-target-1', 'ai-target-2');
            });

            currentShapes.forEach((shapeData, index) => {
                if (shapeData === null) return;
                const placement = currentBestPlacements[index]; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–π –ª—É—á—à–∏–π —Ö–æ–¥
                if (placement) {
                    const startR = placement.startR;
                    const startC = placement.startC;
                    const pattern = shapeData.pattern;
                    const colorClass = `ai-highlight-${index}`;
                    const targetClass = `ai-target-${index}`;
                    
                    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–∏–≥—É—Ä—ã
                    const shapeContainer = document.querySelector(`.shape-container[data-shape-index="${index}"]`);
                    if (shapeContainer) {
                         shapeContainer.classList.add(targetClass);
                    }

                    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —è—á–µ–π–∫–∏ –Ω–∞ –¥–æ—Å–∫–µ
                    for (let r = 0; r < pattern.length; r++) {
                        for (let c = 0; c < pattern[0].length; c++) {
                            if (pattern[r][c] === 1) {
                                const boardR = startR + r;
                                const boardC = startC + c;
                                
                                const cell = gameBoardElement.querySelector(`[data-row="${boardR}"][data-col="${boardC}"]`);
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —è—á–µ–π–∫–∞ –ø—É—Å—Ç–∞, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å
                                if (cell && board[boardR][boardC] === EMPTY_COLOR) { 
                                    cell.classList.add(colorClass);
                                    lastHighlightedCells.push(cell);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        
        // --- –¶–ò–ö–õ –ò–ò –ü–†–û–¢–ò–í –ò–ò ---
        
        function runAIGameLoop() {
            if (gameLoopInterval) clearInterval(gameLoopInterval);

            // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Ö–æ–¥–∞–º–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 1 - –±—ã—Å—Ç—Ä–æ, 5 - –º–µ–¥–ª–µ–Ω–Ω–æ
            const delay = 1000 / aiDifficulty; 

            gameLoopInterval = setInterval(() => {
                if (gameMode !== AI_ONLY_MODE) {
                    clearInterval(gameLoopInterval);
                    return;
                }
                
                // 1. –ò—â–µ–º –ª—É—á—à–∏–π —Ö–æ–¥ —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∏–≥—É—Ä
                let overallBestScore = -Infinity;
                let bestMove = null; // { shapeIndex, placement, shapeData }
                
                // –ï—Å–ª–∏ —Ñ–∏–≥—É—Ä –Ω–µ—Ç, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
                if (currentShapes.every(s => s === null)) {
                    generateNextShapes();
                }

                currentShapes.forEach((shapeData, index) => {
                    if (shapeData === null) return;
                    const placement = currentBestPlacements[index]; // –ë–µ—Ä–µ–º —É–∂–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–π –ª—É—á—à–∏–π —Ö–æ–¥

                    if (placement) {
                        // –°–∏–º—É–ª–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —ç—Ç–æ–≥–æ —Ö–æ–¥–∞
                        const result = simulatePlacement(board, shapeData, placement.startR, placement.startC);
                        
                        // –û—Ü–µ–Ω–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                        let currentScore = evaluateBoard(result.board, result.clearedLines) + result.scoreIncrease * 10;
                        
                        if (currentScore > overallBestScore) {
                            overallBestScore = currentScore;
                            bestMove = { shapeIndex: index, placement: placement, shapeData: shapeData };
                        }
                    }
                });
                
                // 2. –í—ã–ø–æ–ª–Ω—è–µ–º –ª—É—á—à–∏–π —Ö–æ–¥
                if (bestMove) {
                    const { shapeIndex, placement, shapeData } = bestMove;
                    
                    // –†–∞–∑–º–µ—â–∞–µ–º —Ñ–∏–≥—É—Ä—É
                    placeShape(shapeData, placement.startR, placement.startC);
                    currentShapes[shapeIndex] = null;
                    
                    // –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–∏–≥—É—Ä—ã –∏–∑ DOM
                    const container = document.querySelector(`.shape-container[data-shape-index="${shapeIndex}"]`);
                    if(container) container.remove();
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ—á–∏—â–∞–µ–º –ª–∏–Ω–∏–∏
                    checkAndClearLines();
                    
                    // 3. –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    if (currentShapes.every(s => s === null)) {
                        generateNextShapes();
                    } else {
                         // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ª—É—á—à–∏–µ —Ö–æ–¥—ã –¥–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è
                        currentBestPlacements = currentShapes.map(s => s ? findBestPlacement(s) : null);
                        isGameOver();
                    }
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ —Ö–æ–¥–∞
                    gameOver();
                }

            }, delay);
        }

        
        // --- –§–£–ù–ö–¶–ò–ò FIREBASE (–ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –ò –†–ï–ö–û–†–î–´) ---
        
        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
         */
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            if (user) {
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–∏–∫–Ω–µ–π–º –∏–ª–∏ –ø—Ä–µ—Ñ–∏–∫—Å email
                authButton.textContent = `–ü—Ä–æ—Ñ–∏–ª—å (${user.displayName || (user.email ? user.email.split('@')[0] : 'Anon')})`;
                await fetchProfile(user.uid); // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
            } else {
                authButton.textContent = '–í—Ö–æ–¥/–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
            }
        });
        
        /**
         * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —É–Ω–∏–∫–∞–ª–µ–Ω –ª–∏ –Ω–∏–∫–Ω–µ–π–º.
         */
        async function isNicknameUnique(nickname, currentUserId) {
             const snapshot = await db.collection("users").where("nickname", "==", nickname).get();
             if (snapshot.empty) {
                 return true;
             }
             
             // –†–∞–∑—Ä–µ—à–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–π —Ç–µ–∫—É—â–∏–π –Ω–∏–∫–Ω–µ–π–º
             const foundUserId = snapshot.docs[0].id;
             return foundUserId === currentUserId;
        }

        /**
         * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
         */
        async function handleAuthSubmit(event) {
            event.preventDefault();
            authMessage.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;

            try {
                if (isRegistering) {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    const defaultNickname = email.split('@')[0];
                    
                    let finalNickname = defaultNickname;
                    let suffix = 0;
                    while (!(await isNicknameUnique(finalNickname, user.uid))) {
                        suffix++;
                        finalNickname = defaultNickname + suffix;
                    }

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∏–∫–Ω–µ–π–º –≤ –ø—Ä–æ—Ñ–∏–ª–µ Firebase
                    await user.updateProfile({ displayName: finalNickname });

                    // –°–æ–∑–¥–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firestore
                    await db.collection("users").doc(user.uid).set({
                        email: email,
                        nickname: finalNickname,
                        highScore: 0,
                        gamesPlayed: 0
                    });

                    authMessage.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í—ã –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É.';
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                    authMessage.textContent = '–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!';
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
                setTimeout(() => authModal.style.display = 'none', 1000);
            } catch (error) {
                authMessage.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
                console.error("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:", error);
            }
        }
        
        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç —Ä–µ–∫–æ—Ä–¥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –∏–≥—Ä.
         */
        async function updateHighScore(newScore) {
            if (!currentUser || gameMode !== NORMAL_MODE) return; // –¢–æ–ª—å–∫–æ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏ –æ–±—ã—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞

            const userRef = db.collection("users").doc(currentUser.uid);
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–∏–∑–±–µ–∂–∞–Ω–∏–µ –≥–æ–Ω–∫–∏ –¥–∞–Ω–Ω—ã—Ö)
                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);

                    if (!userDoc.exists) {
                         // –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ—Ç (–∫—Ä–∞–π–Ω–∏–π —Å–ª—É—á–∞–π, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
                         transaction.set(userRef, {
                            highScore: newScore,
                            gamesPlayed: 1 
                         });
                         return;
                    }
                    
                    const data = userDoc.data();
                    const oldHighScore = data.highScore || 0;
                    const newGamesPlayed = (data.gamesPlayed || 0) + 1;
                    
                    const updates = {
                        gamesPlayed: newGamesPlayed
                    };

                    if (newScore > oldHighScore) {
                        updates.highScore = newScore;
                    }
                    
                    transaction.update(userRef, updates);
                });
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–∫–æ—Ä–¥–∞/—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", error);
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤.
         */
        async function loadLeaderboard() {
            leaderboardList.innerHTML = '<li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>';
            
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º 10 –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ highScore
                const snapshot = await db.collection("users")
                    .orderBy("highScore", "desc")
                    .limit(10)
                    .get();
                
                leaderboardList.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞
                let rank = 1;
                
                if (snapshot.empty) {
                    leaderboardList.innerHTML = '<li>–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ –ø—É—Å—Ç–∞. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</li>';
                } else {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∏–∫–Ω–µ–π–º, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –ø—Ä–µ—Ñ–∏–∫—Å email
                        const nickname = data.nickname || (data.email ? data.email.split('@')[0] : 'Anon');
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <strong>#${rank}</strong> ${nickname}: <span>${data.highScore} –æ—á–∫–æ–≤</span>
                            <button class="game-button view-profile-button" data-user-id="${doc.id}" style="padding: 5px 10px; font-size: 0.8em; margin-left: 10px; background-image: linear-gradient(to right, #6c5ce7 0%, #a29bfe 100%);">–ü—Ä–æ—Ñ–∏–ª—å</button>
                        `;
                        leaderboardList.appendChild(li);
                        rank++;
                    });
                    
                    // NEW: –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ—Ñ–∏–ª—å"
                    document.querySelectorAll('.view-profile-button').forEach(button => {
                        button.onclick = (e) => {
                            e.stopPropagation(); // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–ø–ª—ã—Ç–∏–µ
                            const userId = e.target.dataset.userId;
                            leaderboardModal.style.display = 'none'; // –ó–∞–∫—Ä—ã—Ç—å —Ç–∞–±–ª–∏—Ü—É
                            showProfileModal(userId); // –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏–≥—Ä–æ–∫–∞
                        };
                    });
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤:", error);
                leaderboardList.innerHTML = '<li>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø—Ä–∞–≤–∏–ª–∞ Firestore.</li>';
            }
        }
        
        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ ID.
         */
        async function fetchProfile(userId) {
            try {
                const doc = await db.collection("users").doc(userId).get();
                if (doc.exists) {
                    return doc.data();
                }
                return { nickname: 'Anon', highScore: 0, gamesPlayed: 0 };
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:", error);
                return { nickname: 'Error', highScore: 0, gamesPlayed: 0 };
            }
        }

        /**
         * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
         */
        async function showProfileModal(userId) {
            currentProfileUserId = userId;
            const profileData = await fetchProfile(userId);
            
            const nickname = profileData.nickname || (profileData.email ? profileData.email.split('@')[0] : 'Anon');
            
            profileNicknameElement.textContent = `–ü—Ä–æ—Ñ–∏–ª—å: ${nickname}`;
            profileHighScoreElement.textContent = profileData.highScore;
            profileGamesPlayedElement.textContent = profileData.gamesPlayed;
            
            // –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
            editProfileButton.style.display = 'none';
            if (currentUser && currentUser.uid === currentProfileUserId) {
                editProfileButton.style.display = 'block';
            }
            
            profileMessage.textContent = '';
            hideEditProfile(); // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            profileModal.style.display = 'block';
        }
        
        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è.
         */
        function showEditProfile() {
            isEditProfile = true;
            editProfileForm.style.display = 'block';
            editProfileButton.style.display = 'none';
            
            // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—É—â–∏–º –Ω–∏–∫–Ω–µ–π–º–æ–º
            editNicknameInput.value = profileNicknameElement.textContent.replace('–ü—Ä–æ—Ñ–∏–ª—å: ', '');
        }

        /**
         * –°–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è.
         */
        function hideEditProfile() {
            isEditProfile = false;
            editProfileForm.style.display = 'none';
            if (currentUser && currentUser.uid === currentProfileUserId) {
                editProfileButton.style.display = 'block';
            }
            profileMessage.textContent = '';
        }

        /**
         * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ—Ñ–∏–ª—è.
         */
        async function handleProfileEdit(event) {
            event.preventDefault();
            profileMessage.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            
            const newNickname = editNicknameInput.value.trim();
            
            if (!currentUser || currentUser.uid !== currentProfileUserId) {
                profileMessage.textContent = '–û—à–∏–±–∫–∞: –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å.';
                return;
            }

            if (newNickname.length < 3) {
                profileMessage.textContent = '–ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤.';
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
            const isUnique = await isNicknameUnique(newNickname, currentUser.uid);
            if (!isUnique) {
                profileMessage.textContent = '–û—à–∏–±–∫–∞: –ù–∏–∫–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π.';
                return;
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ Firestore –∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ Firebase Auth
            const userRef = db.collection("users").doc(currentUser.uid);
            try {
                await userRef.update({ nickname: newNickname });
                await currentUser.updateProfile({ displayName: newNickname });
                
                profileMessage.textContent = '–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!';
                
                profileNicknameElement.textContent = `–ü—Ä–æ—Ñ–∏–ª—å: ${newNickname}`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞
                authButton.textContent = `–ü—Ä–æ—Ñ–∏–ª—å (${newNickname})`;
                
                hideEditProfile();
                
            } catch (error) {
                profileMessage.textContent = `–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`;
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:", error);
            }
        }
        
        
        // --- –§–£–ù–ö–¶–ò–ò –ù–ê–°–¢–†–û–ï–ö ---
        
        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º –∏–≥—Ä—ã –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–æ–≤—É—é –∏–≥—Ä—É.
         */
        function selectMode(newMode) {
             if (newMode === AI_ONLY_MODE && gameMode === AI_ONLY_MODE) return; // –ò–∑–±–µ–≥–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

             gameMode = newMode;
             modeModal.style.display = 'none';
             initializeGame(newMode);
        }
        
        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å–º–µ–Ω—ã —Ç–µ–º—ã.
         */
        function updateThemeButton(isDark) {
            themeToggleButton.textContent = isDark ? '–°–º–µ–Ω–∏—Ç—å –¢–µ–º—É (–¢–µ–∫—É—â–∞—è: –¢–µ–º–Ω–∞—è)' : '–°–º–µ–Ω–∏—Ç—å –¢–µ–º—É (–¢–µ–∫—É—â–∞—è: –°–≤–µ—Ç–ª–∞—è)';
        }
        
        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Ç–µ–º—É (–°–≤–µ—Ç–ª–∞—è/–¢–µ–º–Ω–∞—è).
         */
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            
            if (isDark) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
            
            updateThemeButton(isDark);
        }
        
        /**
         * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ò–ò.
         */
        function selectDifficulty(difficulty) {
            aiDifficulty = difficulty;
            localStorage.setItem('aiDifficulty', difficulty);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            difficultyButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.mode-selection-button[data-difficulty="${difficulty}"]`).classList.add('active');
        }

        
        // --- –ó–ê–ü–£–°–ö –ò–ì–†–´ –ò –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ---
        function main() {
             // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ò–ò
            const savedDifficulty = localStorage.getItem('aiDifficulty');
            if (savedDifficulty) {
                aiDifficulty = parseInt(savedDifficulty);
                selectDifficulty(aiDifficulty); // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
            } else {
                 // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                 selectDifficulty(aiDifficulty); // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
            resetButton.onclick = () => initializeGame(gameMode);
            modeButton.onclick = () => modeModal.style.display = 'block';
            settingsButton.onclick = () => settingsModal.style.display = 'block';
            leaderboardButton.onclick = () => {
                 loadLeaderboard();
                 leaderboardModal.style.display = 'block';
            };
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Drag & Drop –Ω–∞ –ø–æ–ª–µ
            gameBoardElement.ondragover = handleDragOver;
            gameBoardElement.ondragenter = handleDragEnter;
            gameBoardElement.ondragleave = handleDragLeave;
            gameBoardElement.ondrop = handleDrop;
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
            authForm.onsubmit = handleAuthSubmit;
            toggleRegisterButton.onclick = () => {
                isRegistering = !isRegistering;
                document.getElementById('auth-submit').textContent = isRegistering ? '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è' : '–í–æ–π—Ç–∏';
                toggleRegisterButton.textContent = isRegistering ? '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏' : '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
            };
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
            editProfileButton.onclick = showEditProfile;
            cancelEditButton.onclick = hideEditProfile;
            editProfileForm.onsubmit = handleProfileEdit;

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            closeButtons.forEach(btn => {
                btn.onclick = (e) => {
                    const modalType = e.target.dataset.modal;
                    if (modalType === 'settings') settingsModal.style.display = 'none';
                    if (modalType === 'mode') modeModal.style.display = 'none';
                    if (modalType === 'auth') authModal.style.display = 'none';
                    if (modalType === 'leaderboard') leaderboardModal.style.display = 'none';
                    if (modalType === 'profile') profileModal.style.display = 'none';
                };
            });
            
            // –ö–ª–∏–∫ –ø–æ –ø—Ä–æ—Ñ–∏–ª—é –≤ –ø–∞–Ω–µ–ª–∏ –≤—Ö–æ–¥–∞
            authButton.onclick = () => {
                if (currentUser) {
                    showProfileModal(currentUser.uid); 
                } else {
                    authModal.style.display = 'block';
                }
            };

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞
            modeSelectionButtons.forEach(btn => {
                btn.onclick = (e) => selectMode(e.currentTarget.dataset.mode);
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            difficultyButtons.forEach(btn => {
                 btn.onclick = (e) => selectDifficulty(parseInt(e.currentTarget.dataset.difficulty));
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
            const isDarkMode = localStorage.getItem('theme') === 'dark';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            }
            updateThemeButton(isDarkMode); // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–º–µ–Ω—ã —Ç–µ–º—ã
            if (themeToggleButton) {
                themeToggleButton.onclick = toggleTheme;
            }
            
            // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
            initializeGame(NORMAL_MODE);
        }
        
        main(); // –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
    </script>
</body>
</html>
